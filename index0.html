<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador CMC — Cascada (API o JSON local)</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22d3ee;
      --accent-2: #38bdf8;
      --border: #1f2937;
      --ring: rgba(56,189,248,.35);
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      background: radial-gradient(1000px 700px at 15% 10%, rgba(56,189,248,.08), transparent 40%),
                  radial-gradient(800px 600px at 85% 20%, rgba(34,211,238,.08), transparent 40%), var(--bg);
      color: var(--text);
    }
    .wrap { max-width: 1100px; margin: 40px auto; padding: 0 16px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border: 1px solid var(--border); border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .header { padding: 24px 24px 0; }
    .header h1 { margin: 0 0 8px; font-size: 24px; letter-spacing: .2px; }
    .header p { margin: 0; color: var(--muted); }
    .controls { display: grid; gap: 16px; padding: 20px 24px; border-top: 1px solid var(--border); }
    .row { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); align-items: end; }
    .row > * { min-width: 0; }
    .row .col-8 { grid-column: span 8; }
    .row .col-7 { grid-column: span 7; }
    .row .col-6 { grid-column: span 6; }
    .row .col-5 { grid-column: span 5; }
    .row .col-4 { grid-column: span 4; }
    .row .col-3 { grid-column: span 3; }
    .row .col-2 { grid-column: span 2; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], select { width: 100%; padding: 10px 12px; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 12px; outline: none; transition: box-shadow .2s, border-color .2s; }
    input[type="file"] { color: var(--muted); }
    input[type="text"]:focus, select:focus { border-color: var(--accent-2); box-shadow: 0 0 0 4px var(--ring); }
    .btn { appearance: none; border: 1px solid var(--border); background: linear-gradient(180deg, #0b1325, #0a1120); color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: transform .04s ease, box-shadow .2s; }
    .btn:hover { box-shadow: 0 10px 25px rgba(34,211,238,.08); border-color: #1f2b3a; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: #164e63; background: linear-gradient(180deg, #0e7490, #155e75); }
    .btn.ghost { background: transparent; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); padding: 0 24px 24px; }
    .grid .span-6 { grid-column: span 6; }
    .grid .span-12 { grid-column: span 12; }
    .grid .span-3 { grid-column: span 3; }
    .muted { color: var(--muted); }
    .hr { border-top: 1px solid var(--border); margin: 12px 0; }
    .payload { background: #0b1220; border: 1px solid var(--border); border-radius: 14px; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12.5px; overflow: auto; max-height: 260px; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; border: 1px solid var(--border); color: var(--muted); }
    .footer { padding: 12px 24px 22px; color: var(--muted); font-size: 12px; }
    .results { background:#0b1220; border:1px solid var(--border); border-radius:14px; padding:12px; max-height:360px; overflow:auto; }
    .inline { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .inline label { margin: 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>Buscador CMC — Cascada (API o JSON local)</h1>
        <p>Por defecto se cargan <code>cmc_category_tree.json</code> y <code>CMC_EM_MUNDIAL.json</code> desde la misma carpeta de esta página y se consulta sobre el JSON local.</p>
      </div>

      <div class="controls">
        <!-- Carga del árbol -->
        <div class="row">
          <div class="col-7">
            <label for="treeUrl">Ruta del archivo del árbol</label>
            <input id="treeUrl" type="text" value="cmc_category_tree.json" />
          </div>
          <div class="col-3">
            <label for="treeFile">…o cargá el árbol desde archivo</label>
            <input id="treeFile" type="file" accept="application/json" />
          </div>
          <div class="col-2">
            <button id="loadBtn" class="btn primary" title="Cargar estructura">Cargar</button>
          </div>
        </div>

        <!-- Selects en cascada -->
        <div class="grid" id="selects"></div>

        <!-- Países coincidentes informativos -->
        <div class="row">
          <div class="col-4">
            <label for="countryHint">Países coincidentes (informativo)</label>
            <select id="countryHint" disabled></select>
          </div>
          <div class="col-4">
            <button id="clearBtn" class="btn ghost">Limpiar selección</button>
          </div>
          <div class="col-4">
            <span class="badge" id="status">Estructura: —</span>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Fuente de datos: API o JSON local -->
        <div class="row">
          <div class="col-6">
            <label>Fuente de datos</label>
            <div class="inline">
              <label><input type="radio" name="source" value="api"> API BIPM</label>
              <label><input type="radio" name="source" value="local" checked> JSON local (respuesta KCDB)</label>
            </div>
          </div>
          <div class="col-4" id="localWrap">
            <label for="respUrl">Ruta del JSON local</label>
            <input id="respUrl" type="text" value="CMC_EM_MUNDIAL.json" />
            <label for="respFile" class="muted" style="margin-top:8px;">…o cargar archivo</label>
            <input id="respFile" type="file" accept="application/json" />
          </div>
          <div class="col-2">
            <button id="queryBtn" class="btn primary">Consultar</button>
          </div>
        </div>

        <div class="grid">
          <div class="span-6">
            <label>Payload de consulta</label>
            <pre class="payload" id="payloadBox">{}</pre>
          </div>
          <div class="span-6">
            <label>Ruta seleccionada en el árbol</label>
            <pre class="payload" id="pathBox">[]</pre>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div class="span-12">
            <label>Resultado</label>
            <pre class="results" id="resultBox">—</pre>
          </div>
        </div>
      </div>

      <div class="footer">Orden: <code>metrologyAreaLabel → countryValue → branchValue → serviceValue → subServiceValue → individualServiceValue → instrument → instrumentMethod</code></div>
    </div>
  </div>

<script>
(function(){
  const FIELDS = [
    'metrologyAreaLabel', 'countryValue', 'branchValue', 'serviceValue', 'subServiceValue', 'individualServiceValue', 'instrument', 'instrumentMethod'
  ];

  const API_URL = 'https://www.bipm.org/api/kcdb/cmc/searchData/physics';
  const DEFAULT_TREE_URL = 'cmc_category_tree.json';
  const DEFAULT_LOCAL_URL = 'CMC_EM_MUNDIAL.json';
  const SPLIT_RE = /\s*[,;/]\s*/;

  const state = {
    tree: null,
    selections: Array(FIELDS.length).fill(null),
    source: 'local',            // por defecto JSON local
    localData: null,
  };

  // ===== Helpers DOM =====
  const el = (sel) => document.querySelector(sel);
  const selectsGrid = el('#selects');
  const payloadBox = el('#payloadBox');
  const pathBox = el('#pathBox');
  const status = el('#status');
  const countryHint = el('#countryHint');
  const resultBox = el('#resultBox');
  const respUrlInput = el('#respUrl');

  function setStatus(msg){ status.textContent = msg; }

  // ===== Árbol y opciones dinámicas =====
  function existsPath(node, level, selections){
    if(!node || typeof node !== 'object') return false;
    if(level === FIELDS.length) return true;
    const sel = selections[level];
    const keys = Object.keys(node).filter(k => k !== '_count');
    if(sel){
      if(!node[sel]) return false;
      return existsPath(node[sel], level+1, selections);
    } else {
      for(const k of keys){ if(existsPath(node[k], level+1, selections)) return true; }
      return false;
    }
  }

  function optionsAtLevel(targetLevel, selections){
    const out = new Set();
    function dfs(node, level){
      if(!node || typeof node !== 'object') return;
      const keys = Object.keys(node).filter(k => k !== '_count');
      if(level === targetLevel){
        for(const k of keys){
          const nextSel = selections.slice();
          nextSel[level] = k;
          if(existsPath(node[k], level+1, nextSel)) out.add(k);
        }
        return;
      }
      const sel = selections[level];
      if(sel){ if(node[sel]) dfs(node[sel], level+1); }
      else { for(const k of keys){ dfs(node[k], level+1); } }
    }
    dfs(state.tree, 0);
    return Array.from(out).sort();
  }

  function updateCountryHint(){
    const idx = FIELDS.indexOf('countryValue');
    const opts = optionsAtLevel(idx, state.selections);
    countryHint.innerHTML = '';
    const ph = document.createElement('option');
    ph.textContent = opts.length ? `${opts.length} país(es) coincidente(s)` : '— sin coincidencias —';
    countryHint.appendChild(ph);
    for(const v of opts){ const o=document.createElement('option'); o.value=v; o.textContent=v; countryHint.appendChild(o); }
    countryHint.disabled = true;
  }

  function createSelect(field, idx){
    const wrap = document.createElement('div');
    wrap.className = 'span-3';
    const label = document.createElement('label'); label.textContent = field;
    const select = document.createElement('select'); select.id = `sel-${field}`;
    const ph = document.createElement('option'); ph.value=''; ph.textContent=`Seleccionar ${field}…`; select.appendChild(ph);
    select.addEventListener('change', () => {
      const value = select.value || null; state.selections[idx] = value; repopulateAll(); renderPayload();
    });
    wrap.appendChild(label); wrap.appendChild(select); return wrap;
  }

  function repopulateAll(){
    for(let i=0; i<FIELDS.length; i++){
      const select = el(`#sel-${FIELDS[i]}`);
      const options = optionsAtLevel(i, state.selections);
      const prev = state.selections[i];
      select.innerHTML = '';
      const ph = document.createElement('option'); ph.value=''; ph.textContent=`Seleccionar ${FIELDS[i]}…`; select.appendChild(ph);
      options.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o); });
      if(prev && options.includes(prev)) select.value = prev; else state.selections[i] = null;
      select.disabled = options.length === 0;
    }
    if(!state.selections[FIELDS.indexOf('countryValue')]) updateCountryHint();
    else {
      countryHint.innerHTML = '';
      const o = document.createElement('option'); o.textContent = `País seleccionado: ${state.selections[FIELDS.indexOf('countryValue')]}`; countryHint.appendChild(o);
    }
  }

  // ===== Payload =====
  function renderPayload(){
    const payload = { page: 0, pageSize: 10000, showTable: true };
    const path = [];
    FIELDS.forEach((f, i) => {
      if(state.selections[i]){ payload[f] = state.selections[i]; path.push(`${f}:${state.selections[i]}`); }
    });
    payloadBox.textContent = JSON.stringify(payload, null, 2);
    pathBox.textContent = JSON.stringify(path, null, 2);
    return payload;
  }

  function clearAll(){ state.selections = Array(FIELDS.length).fill(null); repopulateAll(); renderPayload(); }
  function buildUI(){ selectsGrid.innerHTML=''; FIELDS.forEach((f,i)=>selectsGrid.appendChild(createSelect(f,i))); repopulateAll(); renderPayload(); }

  // ===== Carga utilidades (más robustas) =====
  async function fetchJSON(url){
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return res.json();
  }
  async function loadFromUrl(url){ return fetchJSON(url); }
  function loadFromFile(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onerror=()=>reject(fr.error); fr.onload=()=>{ try{ resolve(JSON.parse(fr.result)); }catch(e){ reject(e); } }; fr.readAsText(file,'utf-8'); }); }

  async function handleLoad(){
    const file = document.getElementById('treeFile').files[0];
    const url = (document.getElementById('treeUrl').value.trim()) || DEFAULT_TREE_URL;
    try{ setStatus('Cargando…'); const data = file? await loadFromFile(file) : await loadFromUrl(url); state.tree = data; setStatus('Estructura: OK'); buildUI(); }
    catch(err){ console.error(err); setStatus('Error al cargar estructura'); alert('No se pudo cargar el árbol: ' + err.message + (location.protocol==='file:' ? '\nSugerencia: abrí el HTML desde un servidor local (no con file://) para permitir fetch de archivos locales.' : '')); }
  }

  // ===== Fuente de datos (API o local) =====
  const sourceRadios = document.getElementsByName('source');
  const localWrap = document.getElementById('localWrap');
  Array.from(sourceRadios).forEach(r => r.addEventListener('change', () => {
    state.source = document.querySelector('input[name="source"]:checked').value;
    localWrap.style.display = state.source === 'local' ? '' : 'none';
  }));

  document.getElementById('respFile').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    try{ state.localData = await loadFromFile(file); alert('JSON local cargado correctamente.'); }
    catch(err){ alert('Error al leer JSON local: ' + err.message); }
  });

  // ===== Consulta =====
  function getArrayFromResponse(resp){
    if(Array.isArray(resp)) return resp;
    if(resp && typeof resp === 'object'){
      if(Array.isArray(resp.data)) return resp.data;
      if(Array.isArray(resp.results)) return resp.results;
    }
    return [];
  }

  function normStr(s){ return (typeof s === 'string') ? s.trim() : s; }
  function recMatches(rec, payload){
    for(const f of FIELDS){
      if(!(f in payload)) continue; // campo no filtrado
      const target = normStr(payload[f]);
      const val = rec[f];
      if(val == null) return false;
      if(f === 'instrument' || f === 'instrumentMethod'){
        if(typeof val === 'string'){
          const parts = val.split(SPLIT_RE).map(v=>v.trim()).filter(Boolean);
          if(!parts.includes(target)) return false;
        } else if(Array.isArray(val)){
          if(!val.map(normStr).includes(target)) return false;
        } else { return false; }
      } else {
        if(Array.isArray(val)){ if(!val.map(normStr).includes(target)) return false; }
        else if(normStr(val) !== target) return false;
      }
    }
    return true;
  }

  async function runQuery(){
    const payload = renderPayload();
    resultBox.textContent = 'Consultando…';

    if(state.source === 'api'){
      try{
        const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const txt = await res.text();
        try{ const json = JSON.parse(txt); resultBox.textContent = JSON.stringify(json, null, 2); }
        catch{ resultBox.textContent = txt; }
        if(!res.ok){ resultBox.textContent = `Error ${res.status}:\n` + resultBox.textContent; }
      }catch(err){ resultBox.textContent = 'Error al consultar la API: ' + err.message + '\n\nSi el navegador bloquea por CORS, serví esta página desde un servidor o usá un proxy.'; }
    } else {
      // Consulta en JSON local
      try{
        // si no hay data cargada aún, intentá traer desde la URL del input
        if(!state.localData){
          const url = (respUrlInput.value || DEFAULT_LOCAL_URL).trim();
          try { state.localData = await loadFromUrl(url); }
          catch(e){ resultBox.textContent = 'No se pudo cargar el JSON local ('+url+').' + (location.protocol==='file:' ? '\n\nSugerencia: abrí el HTML desde un servidor local (no con file://) para permitir fetch de archivos locales.' : ''); return; }
        }
        const arr = getArrayFromResponse(state.localData);
        const filtered = arr.filter(r => recMatches(r, payload));
        const shaped = { page: 0, pageSize: filtered.length, numberOfElements: filtered.length, data: filtered };
        resultBox.textContent = JSON.stringify(shaped, null, 2);
      }catch(err){ resultBox.textContent = 'Error al filtrar JSON local: ' + err.message; }
    }
  }

  // Wire-up
  document.getElementById('loadBtn').addEventListener('click', handleLoad);
  document.getElementById('clearBtn').addEventListener('click', (e)=>{ e.preventDefault(); clearAll(); });
  document.getElementById('queryBtn').addEventListener('click', (e)=>{ e.preventDefault(); runQuery(); });

  // ===== Carga inicial por defecto (con detección de file://) =====
  (async()=>{
    // Selección por defecto: JSON local
    const localRadio = document.querySelector('input[name="source"][value="local"]');
    if(localRadio) localRadio.checked = true;

    const isFile = location.protocol === 'file:';

    // Intentar cargar árbol por defecto y construir UI
    try{
      const turl = (el('#treeUrl').value || DEFAULT_TREE_URL).trim();
      if(isFile){
        // Muchos navegadores bloquean fetch() con file://
        setStatus('Estructura: — (abriste el HTML con file://; cargá el árbol con el botón o usá un servidor local)');
      } else {
        const autoTree = await fetchJSON(turl);
        state.tree = autoTree; setStatus('Estructura: OK'); buildUI();
      }
    }catch(err){ setStatus('Estructura: — (no se pudo cargar por defecto)'); }

    // Intentar cargar JSON local por defecto
    try{
      const rurl = (respUrlInput?.value || DEFAULT_LOCAL_URL).trim();
      if(!isFile){
        const autoResp = await fetchJSON(rurl);
        state.localData = autoResp;
      }
    }catch{}

    // Ejecutar una primera consulta por defecto (si hay árbol cargado)
    //try{ if(state.tree) runQuery(); }catch{}
  })();
})();
</script>
</body>
</html>
